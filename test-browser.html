<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoosat SDK Browser Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #4CAF50;
            margin-top: 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: all 0.2s;
        }
        button:hover {
            background: #45a049;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .output {
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #FFC107; }
    </style>
</head>
<body>
<div class="container">
    <h1>üöÄ Hoosat SDK Browser Test</h1>
    <p>Testing browser-compatible crypto operations</p>

    <button id="btnGenerateKey">Generate Key Pair</button>
    <button id="btnImportKey">Import Key</button>
    <button id="btnValidateAddress">Validate Address</button>
    <button id="btnTestHashing">Test Hashing</button>
    <button id="btnClear">Clear</button>

    <div id="output" class="output">Loading SDK...</div>
</div>

<script type="module">
    const output = document.getElementById('output');

    function log(message, type = 'info') {
        const color = type === 'success' ? '#4CAF50' :
            type === 'error' ? '#f44336' :
                type === 'warning' ? '#FFC107' : '#2196F3';
        output.innerHTML += `<span style="color: ${color}">${message}</span>\n`;
        output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
        output.innerHTML = 'Ready to test...\n';
    }

    // Try to load SDK with error handling
    let HoosatCrypto, HoosatUtils, HOOSAT_PARAMS;

    try {
        log('üîÑ Loading Hoosat SDK...', 'info');

        // Import SDK - it will set up Buffer automatically
        const sdk = await import('./dist/hoosat-sdk.es.js');
        HoosatCrypto = sdk.HoosatCrypto;
        HoosatUtils = sdk.HoosatUtils;
        HOOSAT_PARAMS = sdk.HOOSAT_PARAMS;

        // Buffer should now be available globally (set by index.ts)
        if (typeof Buffer === 'undefined') {
            throw new Error('Buffer is not available. Check index-browser.ts');
        }

        log('‚úÖ SDK loaded successfully!', 'success');
        log('‚úÖ Buffer available globally\n', 'success');
        clearOutput();
        log('SDK ready! Click buttons to test.\n', 'success');

    } catch (error) {
        log(`‚ùå Failed to load SDK: ${error.message}`, 'error');
        log(`\nPlease make sure:`, 'warning');
        log(`1. You ran: npm run build`, 'warning');
        log(`2. File exists: dist/hoosat-sdk.es.js`, 'warning');
        log(`3. You're serving via http:// (not file://)`, 'warning');
        console.error('Full error:', error);

        // Disable buttons if SDK failed to load
        document.querySelectorAll('button').forEach(btn => {
            if (btn.id !== 'btnClear') btn.disabled = true;
        });
    }

    function testGenerateKeyPair() {
        try {
            log('=== Testing Key Pair Generation ===', 'info');

            const wallet = HoosatCrypto.generateKeyPair('mainnet');

            log(`‚úÖ Private Key (32 bytes): ${wallet.privateKey.toString('hex')}`, 'success');
            log(`‚úÖ Public Key (33 bytes): ${wallet.publicKey.toString('hex')}`, 'success');
            log(`‚úÖ Address: ${wallet.address}`, 'success');

            // Validate the generated address
            const isValid = HoosatUtils.isValidAddress(wallet.address);
            log(`‚úÖ Address is valid: ${isValid}`, 'success');

            // Check address type and network
            const network = HoosatUtils.getAddressNetwork(wallet.address);
            const type = HoosatUtils.getAddressType(wallet.address);
            log(`‚úÖ Network: ${network}, Type: ${type}`, 'success');

            log('\n', 'info');
        } catch (error) {
            log(`‚ùå Error: ${error.message}`, 'error');
            console.error('Full error:', error);
        }
    }

    function testImportKey() {
        try {
            log('=== Testing Key Import ===', 'info');

            // Generate a key first
            const original = HoosatCrypto.generateKeyPair('mainnet');
            const privateKeyHex = original.privateKey.toString('hex');

            log(`Generated private key: ${privateKeyHex.slice(0, 16)}...`, 'info');

            // Import it back
            const imported = HoosatCrypto.importKeyPair(privateKeyHex, 'mainnet');

            log(`‚úÖ Original Address: ${original.address}`, 'success');
            log(`‚úÖ Imported Address: ${imported.address}`, 'success');
            log(`‚úÖ Addresses match: ${original.address === imported.address}`, 'success');

            // Test invalid key
            try {
                HoosatCrypto.importKeyPair('0000000000000000000000000000000000000000000000000000000000000000', 'mainnet');
                log('‚ö†Ô∏è  Invalid key was accepted (unexpected)', 'warning');
            } catch (e) {
                log(`‚úÖ Invalid key correctly rejected`, 'success');
            }

            log('\n', 'info');
        } catch (error) {
            log(`‚ùå Error: ${error.message}`, 'error');
            console.error('Full error:', error);
        }
    }

    function testAddressValidation() {
        try {
            log('=== Testing Address Validation ===', 'info');

            // Generate valid address
            const wallet = HoosatCrypto.generateKeyPair('mainnet');

            log(`Testing address: ${wallet.address}`, 'info');
            log(`‚úÖ Is valid: ${HoosatUtils.isValidAddress(wallet.address)}`, 'success');

            // Test invalid addresses
            const testCases = [
                { addr: 'invalid:address123', expected: false, desc: 'Invalid format' },
                { addr: 'hoosat:invalid', expected: false, desc: 'Invalid payload' },
                { addr: 'bitcoin:qz7ulu', expected: false, desc: 'Wrong prefix' },
            ];

            log('\nTesting invalid addresses:', 'info');
            testCases.forEach(test => {
                const isValid = HoosatUtils.isValidAddress(test.addr);
                const result = isValid === test.expected ? '‚úÖ' : '‚ùå';
                log(`${result} ${test.desc}: ${isValid}`, isValid === test.expected ? 'success' : 'error');
            });

            // Test address info
            const network = HoosatUtils.getAddressNetwork(wallet.address);
            const type = HoosatUtils.getAddressType(wallet.address);
            log(`\n‚úÖ Network: ${network}`, 'success');
            log(`‚úÖ Type: ${type}`, 'success');

            log('\n', 'info');
        } catch (error) {
            log(`‚ùå Error: ${error.message}`, 'error');
            console.error('Full error:', error);
        }
    }

    function testHashing() {
        try {
            log('=== Testing Hashing Functions ===', 'info');

            const data = Buffer.from('Hello Hoosat!', 'utf8');
            log(`Input: "Hello Hoosat!" (${data.length} bytes)\n`, 'info');

            // Blake3 hash
            const blake3Hash = HoosatCrypto.blake3Hash(data);
            log(`Blake3 (32 bytes):`, 'info');
            log(`  ${blake3Hash.toString('hex')}`, 'success');

            // Double Blake3 hash
            const doubleHash = HoosatCrypto.doubleBlake3Hash(data);
            log(`\nDouble Blake3 (32 bytes):`, 'info');
            log(`  ${doubleHash.toString('hex')}`, 'success');

            // Keyed hash
            const keyedHash = HoosatCrypto.blake3KeyedHash('TransactionSigningHash', data);
            log(`\nKeyed Blake3 (key: "TransactionSigningHash"):`, 'info');
            log(`  ${keyedHash.toString('hex')}`, 'success');

            // SHA256 hash
            const sha256Hash = HoosatCrypto.sha256Hash(data);
            log(`\nSHA256 (32 bytes):`, 'info');
            log(`  ${sha256Hash.toString('hex')}`, 'success');

            // Verify all hashes are 32 bytes
            const allCorrectLength = [blake3Hash, doubleHash, keyedHash, sha256Hash]
                .every(hash => hash.length === 32);

            log(`\n‚úÖ All hashes are 32 bytes: ${allCorrectLength}`, 'success');
            log('\n', 'info');
        } catch (error) {
            log(`‚ùå Error: ${error.message}`, 'error');
            console.error('Full error:', error);
        }
    }

    // Attach event listeners to buttons
    document.getElementById('btnGenerateKey').addEventListener('click', testGenerateKeyPair);
    document.getElementById('btnImportKey').addEventListener('click', testImportKey);
    document.getElementById('btnValidateAddress').addEventListener('click', testAddressValidation);
    document.getElementById('btnTestHashing').addEventListener('click', testHashing);
    document.getElementById('btnClear').addEventListener('click', clearOutput);

    // Add click feedback
    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log(`Button clicked: ${this.id}`);
        });
    });
</script>
</body>
</html>